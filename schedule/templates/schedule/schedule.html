{% extends "core/base.html" %}
{% block pageContent %}

<!-- Cabeçalho -->
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Agenda de Serviços</h4>
            <div class="text-end">
                <span class="badge bg-info me-2">{{ total_schedules }} agendamento{{ total_schedules|pluralize }}</span>
                <a href="{% url 'schedule:schedule-create' %}" class="btn btn-primary bg-gradient btn-sm rounded-0">
                    <i class="mdi mdi-plus"></i><span> Novo Agendamento</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card p-3">
        <form method="GET" class="row g-2">
            <div class="col-md-6">
                <input type="text" 
                       name="search" 
                       value="{{ search }}" 
                       class="form-control" 
                       placeholder="Buscar por cliente, profissional ou serviço..."
                       id="searchInput">
            </div>
            <div class="col-md-3">
                <select name="status" class="form-select">
                    <option value="">Todos os status</option>
                    {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="mdi mdi-magnify"></i> Buscar
                    </button>
                    {% if search or status_filter %}
                    <a href="{% url 'schedule:schedule-view' %}" class="btn btn-outline-secondary">
                        <i class="mdi mdi-close"></i> Limpar
                    </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Tabela de Agendamentos -->
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <colgroup>
                    <col width="15%">
                    <col width="15%">
                    <col width="15%">
                    <col width="15%">
                    <col width="10%">
                    <col width="10%">
                    <col width="10%">
                    <col width="10%">
                </colgroup>
                <thead>
                    <tr>
                        <th class="text-center py-1">Cliente</th>
                        <th class="text-center py-1">Profissional</th>
                        <th class="text-center py-1">Serviço</th>
                        <th class="text-center py-1">Categoria</th>
                        <th class="text-center py-1">Data</th>
                        <th class="text-center py-1">Hora</th>
                        <th class="text-center py-1">Status</th>
                        <th class="text-center py-1">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for schedule in schedules %}
                    <tr>
                        <td class="px-2 py-1 text-start">{{ schedule.client.name }}</td>
                        <td class="px-2 py-1 text-start">{{ schedule.profissional.name }}</td>
                        <td class="px-2 py-1 text-start">{{ schedule.service.name }}</td>
                        <td class="px-2 py-1 text-start">{{ schedule.service.category.name }}</td>
                        <td class="px-2 py-1 text-center">{{ schedule.date_schedule|date:"d/m/Y" }}</td>
                        <td class="px-2 py-1 text-center">{{ schedule.time_schedule|time:"H:i" }}</td>
                        <td class="px-2 py-1 text-center">
                            {% if schedule.status == 'agendado' %}
                                <span class="badge bg-primary">{{ schedule.get_status_display }}</span>
                            {% elif schedule.status == 'em_atendimento' %}
                                <span class="badge bg-warning">{{ schedule.get_status_display }}</span>
                            {% elif schedule.status == 'concluido' %}
                                <span class="badge bg-success">{{ schedule.get_status_display }}</span>
                            {% elif schedule.status == 'cancelado' %}
                                <span class="badge bg-danger">{{ schedule.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td class="px-2 py-1 text-center">
                            <button type="button" 
                                    class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded me-1" 
                                    title="Visualizar"
                                    onclick="viewScheduleDetails('{{ schedule.pk }}')">
                                <i class="material-icons mdc-button__icon">visibility</i>
                            </button>
                            <a href="{% url 'schedule:schedule-update' schedule.pk %}" 
                               class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded me-1" 
                               title="Editar">
                                <i class="material-icons mdc-button__icon">edit</i>
                            </a>
                            <a href="{% url 'schedule:schedule-delete' schedule.pk %}" 
                               class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded" 
                               title="Excluir">
                                <i class="material-icons mdc-button__icon">delete_outline</i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            {% if search or status_filter %}
                                <p class="mb-0">Nenhum agendamento encontrado com os filtros aplicados</p>
                                <a href="{% url 'schedule:schedule-view' %}" class="btn btn-link">Ver todos os agendamentos</a>
                            {% else %}
                                <p class="mb-0">Nenhum agendamento cadastrado</p>
                                <a href="{% url 'schedule:schedule-create' %}" class="btn btn-primary btn-sm mt-2">
                                    <i class="mdi mdi-plus"></i> Criar primeiro agendamento
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Paginação -->
{% if is_paginated %}
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card p-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="pagination-info">
                <small class="text-muted">
                    Exibindo {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ page_obj.paginator.count }} agendamentos
                </small>
            </div>
            
            <nav aria-label="Navegação da página">
                <ul class="pagination pagination-sm mb-0">
                    <!-- Primeira página -->
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}page=1" aria-label="Primeira">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% endif %}

                    <!-- Páginas -->
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    <!-- Próxima página -->
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Próxima">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% if search %}search={{ search }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ page_obj.paginator.num_pages }}" aria-label="Última">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal para visualizar detalhes -->
<div class="modal fade" id="scheduleDetailModal" tabindex="-1" aria-labelledby="scheduleDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleDetailModalLabel">Detalhes do Agendamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="scheduleDetailContent">
                <!-- Conteúdo será carregado via AJAX -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Foco automático no campo de busca ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput && !searchInput.value) {
        searchInput.focus();
    }
});

// Função para visualizar detalhes do agendamento
function viewScheduleDetails(scheduleId) {
    const modal = new bootstrap.Modal(document.getElementById('scheduleDetailModal'));
    const content = document.getElementById('scheduleDetailContent');
    
    // Mostrar loading
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Fazer requisição AJAX
    fetch(`/schedule/detail/${scheduleId}/`)
        .then(response => response.json())
        .then(data => {
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Informações do Cliente</h6>
                        <p><strong>Nome:</strong> ${data.client_name}</p>
                        <p><strong>Email:</strong> ${data.client_email || 'Não informado'}</p>
                        <p><strong>Telefone:</strong> ${data.client_phone || 'Não informado'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Informações do Profissional</h6>
                        <p><strong>Nome:</strong> ${data.profissional_name}</p>
                        <p><strong>Especialidade:</strong> ${data.profissional_especialty}</p>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Informações do Serviço</h6>
                        <p><strong>Serviço:</strong> ${data.service_name}</p>
                        <p><strong>Categoria:</strong> ${data.service_category}</p>
                        <p><strong>Preço:</strong> R$ ${data.service_price}</p>
                        <p><strong>Duração:</strong> ${data.service_duration} minutos</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Informações do Agendamento</h6>
                        <p><strong>Data:</strong> ${data.date_schedule}</p>
                        <p><strong>Hora:</strong> ${data.time_schedule}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge ${getStatusBadgeClass(data.status_value)}">${data.status}</span>
                        </p>
                        <p><strong>Criado em:</strong> ${data.created_at}</p>
                        ${data.data_conclusao ? `<p><strong>Concluído em:</strong> ${data.data_conclusao}</p>` : ''}
                    </div>
                </div>
            `;
        })
        .catch(error => {
            content.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    Erro ao carregar os detalhes do agendamento.
                </div>
            `;
        });
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'agendado': return 'bg-primary';
        case 'em_atendimento': return 'bg-warning';
        case 'concluido': return 'bg-success';
        case 'cancelado': return 'bg-danger';
        default: return 'bg-secondary';
    }
}
</script>

{% endblock pageContent %}

